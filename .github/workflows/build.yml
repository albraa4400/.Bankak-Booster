name: Install Tools & Accept Licenses
        run: |
          sudo apt update
          sudo apt install -y python3-pip build-essential git zip unzip zlib1g-dev libffi-dev libssl-dev autoconf automake libtool
          pip3 install --user --upgrade buildozer cython==0.29.33 kivy
          mkdir -p ~/.android && touch ~/.android/repositories.cfg
          yes | sdkmanager --licenses || true

      # 3. حقن الإصدارات الدقيقة التي طلبتها أنت (الإجبار التقني)
      - name: Force Insert Versions (NDK Full Version)
        run: |
          # حقن الرقم الدقيق لضمان عدم حدوث تعارض Aidl أو NDK Unsupported
          sed -i 's/^#\? \?android.ndk = .*/android.ndk = 25.2.9519653/' buildozer.spec
          sed -i 's/^#\? \?android.api = .*/android.api = 33/' buildozer.spec
          sed -i 's/^#\? \?android.minapi = .*/android.minapi = 21/' buildozer.spec
          sed -i 's/^#\? \?android.archs = .*/android.archs = arm64-v8a/' buildozer.spec
          sed -i 's/^#\? \?android.acceptsdklicense = .*/android.acceptsdklicense = True/' buildozer.spec

      # 4. بناء الـ APK مع معالجة الأخطاء آلياً
      - name: Build APK (Force Mode)
        run: |
          export APPANDROIDACCEPTSDKLICENSE=1
          export BUILDOZERALLOWORGNAMESTART=1
          
          # تشغيل البناء مع محاولة الإنقاذ في حال حدوث Broken pipe
          yes | buildozer -v android debug || (buildozer android clean && yes | buildozer -v android debug)
      
      - name: Final Result Upload
        uses: actions/upload-artifact@v4
        with:
          name: Bankak-Booster-NDK-Fixed
          path: bin/*.apk
